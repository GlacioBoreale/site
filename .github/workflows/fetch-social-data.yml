name: Fetch Social Data

on:
  schedule:
    - cron: '0,15,30,45 * * * *'
  workflow_dispatch:

jobs:
  fetch-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch all data and generate cache
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          python3 - << 'PYEOF'
import json, os, random, re, subprocess
import urllib.request, urllib.parse

TWITCH_CLIENT_ID     = os.environ['TWITCH_CLIENT_ID']
TWITCH_CLIENT_SECRET = os.environ['TWITCH_CLIENT_SECRET']
YOUTUBE_API_KEY      = os.environ['YOUTUBE_API_KEY']

def get(url, headers=None):
    req = urllib.request.Request(url, headers=headers or {})
    with urllib.request.urlopen(req) as r:
        return json.loads(r.read())

def post(url, data):
    encoded = urllib.parse.urlencode(data).encode()
    req = urllib.request.Request(url, data=encoded, method='POST')
    with urllib.request.urlopen(req) as r:
        return json.loads(r.read())

# ── TWITCH TOKEN ──────────────────────────────────────────────────────
token_data = post('https://id.twitch.tv/oauth2/token', {
    'client_id': TWITCH_CLIENT_ID,
    'client_secret': TWITCH_CLIENT_SECRET,
    'grant_type': 'client_credentials'
})
TOKEN = token_data['access_token']
TH = {'Client-ID': TWITCH_CLIENT_ID, 'Authorization': 'Bearer ' + TOKEN}

# ── TWITCH USER ───────────────────────────────────────────────────────
user = get('https://api.twitch.tv/helix/users?login=glacioborealevt', TH)['data'][0]
USER_ID      = user['id']
DISPLAY_NAME = user['display_name']
PROFILE_IMG  = user['profile_image_url']
OFFLINE_IMG  = user.get('offline_image_url', '')

followers_data = get('https://api.twitch.tv/helix/channels/followers?broadcaster_id=' + USER_ID, TH)
FOLLOWERS = followers_data['total']

# ── TWITCH STREAM ─────────────────────────────────────────────────────
stream_data = get('https://api.twitch.tv/helix/streams?user_login=glacioborealevt', TH)['data']
IS_LIVE = len(stream_data) > 0

stream = {}
if IS_LIVE:
    s = stream_data[0]
    game_id = s.get('game_id', '')
    box_art = ''
    if game_id and game_id != '0':
        game_data = get('https://api.twitch.tv/helix/games?id=' + game_id, TH)['data']
        if game_data:
            box_art = game_data[0]['box_art_url'].replace('{width}','144').replace('{height}','192')
    stream = {
        'title':      s['title'],
        'game':       s['game_name'],
        'gameBoxArt': box_art,
        'viewers':    s['viewer_count'],
        'startedAt':  s['started_at'],
        'thumbnail':  s['thumbnail_url'].replace('{width}','1280').replace('{height}','720')
    }
else:
    stream = {'title':'','game':'','gameBoxArt':'','viewers':0,'startedAt':'','thumbnail':''}

# ── TWITCH CLIPS ──────────────────────────────────────────────────────
clips_raw = get('https://api.twitch.tv/helix/clips?broadcaster_id=' + USER_ID + '&first=20', TH).get('data', [])

def clip_obj(c):
    return {'title': c['title'], 'url': c['url'], 'thumbnail': c['thumbnail_url'],
            'views': c['view_count'], 'duration': c['duration'], 'creator': c['creator_name']}

sorted_clips = sorted(clips_raw, key=lambda c: c['view_count'], reverse=True)
top_clips    = [clip_obj(c) for c in sorted_clips[:3]]
top_urls     = {c['url'] for c in sorted_clips[:3]}
remaining    = [c for c in clips_raw if c['url'] not in top_urls]
random_clips = [clip_obj(c) for c in random.sample(remaining, min(3, len(remaining)))]

# ── YOUTUBE ───────────────────────────────────────────────────────────
def yt(path):
    sep = '&' if '?' in path else '?'
    return get('https://www.googleapis.com/youtube/v3/' + path + sep + 'key=' + YOUTUBE_API_KEY)

channel_data = yt('channels?part=snippet,statistics&forHandle=@glacioborealevt')
if not channel_data.get('items'):
    channel_data = yt('channels?part=snippet,statistics&forUsername=glacioborealevt')
if not channel_data.get('items'):
    s = yt('search?part=snippet&q=GlacioBoreale&type=channel&maxResults=1')
    cid = s['items'][0]['id']['channelId']
    channel_data = yt('channels?part=snippet,statistics&id=' + cid)

ch       = channel_data['items'][0]
YT_NAME  = ch['snippet']['title']
YT_SUBS  = int(ch['statistics']['subscriberCount'])
YT_THUMB = ch['snippet']['thumbnails']['default']['url']
CH_ID    = ch['id']

search = yt('search?part=snippet&channelId=' + CH_ID + '&maxResults=10&order=date&type=video')
video_ids = ','.join(i['id']['videoId'] for i in search.get('items', []) if i.get('id', {}).get('videoId'))

details = yt('videos?part=contentDetails,snippet,statistics&id=' + video_ids).get('items', [])

def parse_duration(iso):
    h = int(re.search(r'(\d+)H', iso).group(1)) if re.search(r'(\d+)H', iso) else 0
    m = int(re.search(r'(\d+)M', iso).group(1)) if re.search(r'(\d+)M', iso) else 0
    s = int(re.search(r'(\d+)S', iso).group(1)) if re.search(r'(\d+)S', iso) else 0
    return h * 3600 + m * 60 + s

yt_videos = []
for v in details:
    if parse_duration(v.get('contentDetails', {}).get('duration', 'PT0S')) > 150:
        yt_videos.append({
            'title':       v['snippet']['title'],
            'videoId':     v['id'],
            'thumbnail':   v['snippet']['thumbnails'].get('medium', v['snippet']['thumbnails'].get('default', {})).get('url', ''),
            'publishedAt': v['snippet']['publishedAt'],
            'url':         'https://www.youtube.com/watch?v=' + v['id'],
            'viewCount':   int(v.get('statistics', {}).get('viewCount', 0))
        })
        if len(yt_videos) >= 3:
            break

# ── SCRIVI JSON ───────────────────────────────────────────────────────
updated_at = subprocess.check_output(['date', '-u', '+%Y-%m-%dT%H:%M:%SZ']).decode().strip()

data = {
    'updatedAt': updated_at,
    'twitch': {
        'displayName':  DISPLAY_NAME,
        'profileImage': PROFILE_IMG,
        'followers':    FOLLOWERS,
        'url':          'https://twitch.tv/glacioborealevt',
        'isLive':       IS_LIVE,
        'stream':       stream,
        'offlineImage': OFFLINE_IMG,
        'topClips':     top_clips,
        'randomClips':  random_clips
    },
    'youtube': {
        'displayName': YT_NAME,
        'thumbnail':   YT_THUMB,
        'subscribers': YT_SUBS,
        'url':         'https://www.youtube.com/@glacioborealevt',
        'recentVideos': yt_videos
    },
    'discord':   {'url': 'https://discord.gg/nsdCYSxzuR'},
    'instagram': {'url': 'https://www.instagram.com/glacioboreale_vt/'},
    'tiktok':    {'url': 'https://www.tiktok.com/@glacioborealevt'}
}

with open('assets/data/api_cache.json', 'w') as f:
    json.dump(data, f, indent=2, ensure_ascii=False)

print('api_cache.json generato!')
print(f"Twitch: live={IS_LIVE}, viewers={stream['viewers']}, followers={FOLLOWERS}")
print(f"YouTube: {YT_SUBS} iscritti, {len(yt_videos)} video")
PYEOF

      - name: Commit and push api_cache.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/data/api_cache.json
          git diff --staged --quiet || git commit -m "chore: update api_cache.json [skip ci]"
          git push
